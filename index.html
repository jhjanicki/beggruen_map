<!DOCTYPE html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8" />
  <title>Planetary</title>
  <meta name="title" content="" />
  <meta name="description" content="" />
  <meta name="author" content="" />
  <meta name="keywords" content="" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" type="image/png" href="./img/favicon.png" />
  <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' rel='stylesheet' type='text/css'>
  <link href='https://api.mapbox.com/mapbox-gl-js/v1.6.0/mapbox-gl.css' rel='stylesheet' />
  <link href="https://fonts.googleapis.com/css2?family=Albert+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap"
    rel="stylesheet">

  <style>
    body {
      font-family: "Albert Sans", sans-serif;
      -webkit-font-smoothing: antialiased;
      background-color: #CBD0D3;
      overflow-x: hidden;
    }

    .navbar {
      position: relative;
      top: 0;
      left: 0;
      width: 100%;
      padding: 10px 0px;
      text-align: right;
    }

    .navbar li {
      display: inline;
      padding: 10px;
      margin-right: 20px;

    }

    .navbar li a {
      color: #000;
      font-size: 20px;
    }

    .navbar li a:hover {
      font-weight: 700;
      transition: all 0.5s ease;
      cursor: pointer;
    }

    .chartWrapper {
      margin-top: -50px;
      width: 90%;
      height: 100vh;
      margin-left: auto;
      margin-right: auto;
    }

    .land,
    .land2 {
      fill: #d9cdc2;
      stroke: #808080;
    }

    svg {
      margin-top: -10px;
    }

    /* svg {
      margin-top: -100px;
      transform: rotate(45deg);
    }

    @media only screen and (max-width: 600px) {
      svg {
        margin-top: 0px;
        transform: rotate(0deg);
      }
    } */

    circle:hover {
      cursor: pointer !important;
    }

    .hover {
      font-weight: 700;
    }

    .button {
      min-width: 110px;
      text-transform: uppercase;
      padding: 8px;
      width: auto;
      display: inline-block;
      text-align: center;
      border: 1px solid #000;
      margin-top: 20px;
      border-radius: 3px;
      font-weight: 700;
    }

    .button:hover {
      transition: all 0.5s ease;
      background-color: #000;
      color: #d8cac0;
      cursor: pointer;
    }

    @media only screen and (max-width: 1100px) {
      .chartWrapper {
        height: 600px;
        width: 85%;
        margin-top: 0px;
        margin-left: auto;
        margin-right: auto;
      }

    }

    @media only screen and (max-width: 850px) {
      .chartWrapper {
        height: 500px;
        margin-left: auto;
        margin-right: auto;
      }
    }

    #searchform {
      display: block;
      margin: 30px auto 20px;
      padding-right: 20px;
      width: 100%;
      max-width: 400px;
    }

    span {
      font-size: 1.5em;
    }

    #search-bar {
      display: block;
      margin: 10px 0 0;
      width: 100%;
      padding: 5px 10px;
      font-size: 16px;
    }

    #searchform input {
      background-color: #fff;
      color: #000;
      border: 1px solid #808080;
    }

    .output {
      list-style: none;
      max-width: 400px;
      min-height: 0px;
      border-top: 0 !important;
      color: #767676;
      font-size: .75em;
      transition: min-height 0.2s;
      position: absolute;
      z-index: 5;
      padding-left: 0px;

    }

    .output,
    #search-bar {
      background: #fff;
      border: 1px solid #767676;
    }

    .prediction-item {
      padding: .5em .75em;
      transition: color 0.2s, background 0.2s;
    }

    .output:hover .focus {
      background: #fff;
      color: #767676;
    }

    .prediction-item:hover,
    .focus,
    .output:hover .focus:hover {
      background: #ddd;
      color: #333;
    }

    .prediction-item:hover {
      cursor: pointer;
    }

    .prediction-item strong {
      color: #333;
    }

    .prediction-item:hover strong {
      color: #000;
    }

    /* #toggleWrapper {
      position: absolute;
      bottom: 10px;
      right: 20px;
    } */

    .toggleText {
      margin-top: 10px;
      font-size: 16px;
    }

    /* Toggle button related */
    .toggle,
    .toggle2,
    .toggle3,
    .toggle4,
    .toggle5 {
      position: relative;
      height: 14px;
      width: 35px;
      border-radius: 15px;
      background: #b7b2ab;
      margin-right: 5px;
    }

    .toggle input,
    .toggle2 input,
    .toggle3 input,
    .toggle4 input,
    .toggle5 input {
      opacity: 0;
      width: 100%;
      height: 200%;
      position: absolute;
      top: -7px;
      left: 0;
      z-index: 2;
      margin: 0
    }

    .toggle__pointer {
      position: absolute;
      top: -2px;
      left: 18px;
      width: 20px;
      height: 20px;
      border-radius: 15px;
      background-color: #007979;
      -webkit-transition: left .15s ease-out;
      transition: left .15s ease-out;
    }

    .toggle input:nth-child(2):checked+.toggle__pointer,
    .toggle2 input:nth-child(2):checked+.toggle__pointer,
    .toggle3 input:nth-child(2):checked+.toggle__pointer,
    .toggle4 input:nth-child(2):checked+.toggle__pointer,
    .toggle5 input:nth-child(2):checked+.toggle__pointer {
      left: 0px;
      background-color: #777777;
    }

    .toggle__pointer.color1 {
      background-color: #d69a07;
    }

    .toggle__pointer.color2 {
      background-color: #db311b;
    }

    .toggle__pointer.color3 {
      background-color: #71918a;
    }

    .toggle__pointer.color4 {
      background-color: #c9bc11;
    }

    .toggle__pointer.color5 {
      background-color: #39603d;
    }

    .toggle__pointer.color6 {
      background-color: #305d77;
    }

    .toggle input:nth-child(2):checked,
    .toggle2 input:nth-child(2):checked,
    .toggle3 input:nth-child(2):checked,
    .toggle4 input:nth-child(2):checked,
    .toggle5 input:nth-child(2):checked {
      z-index: 1;
    }

    .item {
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
      margin-left: 0px;
    }


    #resetZoom:hover {
      cursor: pointer;
    }

    .selection {
      opacity: 1;
      fill-opacity: 1;
    }

    #map {
      width: 280px;
      height: 200px;
      margin-left: auto;
      margin-right: auto;
      padding: 5px 18px 5px 2px;
    }

    .tooltip {
      position: absolute;
      top: 100px;
      left: 100px;
      -moz-border-radius: 5px;
      border-radius: 5px;
      width: 300px;
      background: #7ec7d9;
      color: black;
      padding: 10px;
      font-size: 14px;
      z-index: 10;
      min-height: 200px;
      max-height: 500px;
      overflow: auto;
    }

    .tooltip h4 {
      font-family: "Albert Sans", sans-serif;
      font-size: 20px;
      font-weight: 700;
    }

    .tooltip p {
      font-family: "Albert Sans", sans-serif;
      font-size: 16px;
      color: #000;
      margin-top: 4px;
    }

    .tooltip a {
      color: #000 !important;
      text-decoration: underline;
    }

    .close {
      position: absolute;
      right: 7px;
      top: 5px;
      color: black;
      opacity: 1;
      font-size: 18px;
    }

    .close:hover {
      cursor: pointer !important;
    }

    .focusarea {
      color: #fff;
      padding: 3px;
      width: 100%;
      font-family: "Albert Sans", sans-serif;
      font-size: 18px;
      font-weight: 700;
      border-radius: 3px;
    }

    .more {
      position: absolute;
      right: 2px;
      bottom: 8px;
      color: black;
      opacity: 1;
      font-family: "Albert Sans", sans-serif;
      font-size: 16px;
      z-index: 100;
    }

    .back {
      margin-left: 230px;
      color: black;
      opacity: 1;
      font-family: "Albert Sans", sans-serif;
      font-size: 16px;
      z-index: 100;
    }

    .more:hover,
    .back:hover {
      cursor: pointer !important;
      font-weight: 700;
    }

    .none {
      display: none;
    }

    .show {
      display: inherit;
    }

    #logo {
      width: 200px;
      position: absolute;
      top: 10px;
      left: 10px;
    }

    #locator {
      width: 150px;
      position: absolute;
      bottom: 20px;
      left: 10px;
    }
  </style>
</head>

<body>


  <img id="logo" src="./img/logo.svg" />
  <img id="locator" src="./img/globe.svg" />

  <div class="tooltip">
    <span class="close">X</span>
    <div class="front show">
      <span class="more">More→</span>
    </div>
    <div class="back none">
      <span class="back">Back→</span>
    </div>
  </div>
  <div class="wrapper">

    <div class="navbar">
      <li><a href="index.html">map</a></li>
      <li><a href="individuals.html">individuals</a></li>
    </div>

    <div id="locator"></div>

    <div class="row">
      <div class="col-md-9">
        <div class="chartWrapper">
          <div id="chart1"></div>
        </div>
      </div>
      <div class="col-md-3">
        <form id="searchform">
          <span>Search for organization or location → </span>
          <input type="text" id="search-bar" autocomplete="off" placeholder="Type something here" />
          <ul class="output" style="display:none;">
          </ul>
          <p id="reset" class="button">reset</p>
          <p id="resetZoom" class="button">reset zoom</p>
        </form>
        <div id="toggleWrapper">
          <div class="itemWrapper">
            <div class='toggle item filters' id="filter1">
              <input id='layer1On' type="radio" value="layer1On" name="toggle" checked='checked'>
              <input id='layer1Off' type="radio" value="layer1Off" name="toggle">
              <div class="toggle__pointer color1"></div>
            </div>
            <div class="item toggleText">
              <p id="one">Solutions & Politics</p>
            </div>
          </div>
          <div class="itemWrapper">
            <div class='row toggle item filters' id="filter2">
              <input id='layer2On' type="radio" value="layer2On" name="toggle2" checked='checked'>
              <input id='layer2Off' type="radio" value="layer2Off" name="toggle2">
              <div class="toggle__pointer color2"></div>
            </div>
            <div class="item toggleText">
              <p id="two">Habitability & Hospitability</p>
            </div>
          </div>
          <div class="itemWrapper">
            <div class='row toggle3 item filters' id="filter3">
              <input id='layer3On' type="radio" value="layer3On" name="toggle3" checked='checked'>
              <input id='layer3Off' type="radio" value="layer3Off" name="toggle3">
              <div class="toggle__pointer color3"></div>
            </div>
            <div class="item toggleText">
              <p id="three">Justice & Ethics</p>
            </div>
          </div>
          <div class="itemWrapper">
            <div class='row toggle4 item filters' id="filter4">
              <input id='layer4On' type="radio" value="layer4On" name="toggle4" checked='checked'>
              <input id='layer4Off' type="radio" value="layer4Off" name="toggle4">
              <div class="toggle__pointer color4"></div>
            </div>
            <div class="item toggleText">
              <p id="four">Earth System Science</p>
            </div>
          </div>
          <div class="itemWrapper">
            <div class='row toggle5 item filters' id="filter5">
              <input id='layer5On' type="radio" value="layer5On" name="toggle5" checked='checked'>
              <input id='layer5Off' type="radio" value="layer5Off" name="toggle5">
              <div class="toggle__pointer color5"></div>
            </div>
            <div class="item toggleText">
              <p id="five">Solutions & Economics</p>
            </div>
          </div>
          <div class="itemWrapper">
            <div class='row toggle5 item filters' id="filter6">
              <input id='layer6On' type="radio" value="layer6On" name="toggle6" checked='checked'>
              <input id='layer6Off' type="radio" value="layer6Off" name="toggle6">
              <div class="toggle__pointer color6"></div>
            </div>
            <div class="item toggleText">
              <p id="six">Indigenous Knowledge</p>
            </div>
          </div>
        </div>
      </div>
    </div>


  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.2.0/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
  <script src="https://d3js.org/d3-array.v1.min.js"></script>
  <script src="https://d3js.org/d3-geo.v1.min.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v1.6.0/mapbox-gl.js'></script>
  <script src="./js/tooltip.js"></script>
  <script>

    // whenever I filter then reset, I cannot click anymore

    mapboxgl.accessToken = 'pk.eyJ1IjoiamhqYW5pY2tpIiwiYSI6Il9vb1ZlWnMifQ.zJie3Sr8zh3h5rR8IBMB2A';


    const windowWidth = $(window).width();
    const windowHeight = $(window).height();

    $(window).resize(function () {
      if (
        windowWidth != $(window).width() ||
        windowHeight != $(window).height()
      ) {
        location.reload();
        return;
      }
    });

    const searchformWidth = $("#searchform").width();
    $(".output").css("width", searchformWidth);
    // think about search + toggle, what do we want one a category is toggled off but someone searches for an org in that category?

    const figure = d3.selectAll(".chartWrapper");
    let width = figure.node().getBoundingClientRect().width;
    let height = figure.node().getBoundingClientRect().height;

    let activeCategories = ['Solutions & Politics', 'Habitability & Hospitability', 'Justice & Ethics', 'Earth System Science', 'Solutions & Economics', 'Indigenous Knowledge']
    let allCategories = ['Solutions & Politics', 'Habitability & Hospitability', 'Justice & Ethics', 'Earth System Science', 'Solutions & Economics', 'Indigenous Knowledge']

    let tooltip = floatingTooltip('gates_tooltip', 240, 10);
    let clicked = false;
    let isZoomed = false;
    let brushing = false; // to make sure tooltip won't show up when brushing


    // Prepare our physical space
    const svg = d3
      .select("#chart1")
      .append("svg")
      .attr("width", width)
      .attr("height", height)


    const svg2 = d3
      .select("#locator")
      .append("svg")
      .attr("width", 200)
      .attr("height", 200);


    //PREVENT ZOOM ON CLICK>... now it's prevented initally but onoce the user zooms then they can click and zoom, and it goes back to the previous zoom level

    // +30 to show NZ
    let projection = d3.geoPeirceQuincuncial()
      .fitSize([width, height + 50], {
        type: "Sphere"
      })
      .precision(0.1)
      .scale((width + 100) / 2 / Math.PI)
    // .rotate([-100, 0])

    let path = d3.geoPath().projection(projection);

    const colorScale = d3.scaleOrdinal()
      .range(["#d69a07", "#db311b", "#71918a", "#c9bc11", "#39603d", "#305d77"]);


    let brush = d3.brush()
      .on('brush', brushMove)
      .on("end", brushEnd);

    let brushExtent;
    let brushedSufficient = true; //check if dragged area big enough

    let transformed;
    let transformedLevel = 1;

    let ids;

    function zoomEnd() {
      d3.select(".selection").style("display", "none");
      d3.selectAll(".handle").style("display", "none");
    }


    const zoom = d3.zoom()
      .scaleExtent([1, Infinity])
      .translateExtent([
        [0, 0],
        [width, height]
      ])
      .extent([
        [0, 0],
        [width, height]
      ])
      .on("zoom", zoomed)
      .on("end", zoomEnd);

    //init brush function
    function initBrush() {
      svg.call(brush);
    }

    //brushMove functions

    function brushMove(e) {

      brushing = true;
      tooltip.hideTooltip();


      svg.selectAll(".selection").attr("stroke-width", 2 / transformedLevel).attr("stroke", "white").attr("stroke-dasharray", `${12 / transformedLevel},${6 / transformedLevel}`).attr("fill", "none")



      // .attr("fill", texture.url()).attr("opacity", 1).attr("fill-opacity", 1)

      // d3.select(`#${texture.id()} path`).attr("transform", "translate(0,0)")

      //update brush extent
      brushExtent = e.selection;
      //update points style within the rect
      svg.selectAll("circle.point")
        .attr("fill", d => isInBrushExtent(d) ? 'white' : colorScale(d.Category))
        .raise(); // in order to be able to hover

      //check brush extent to see if it's big enough to brush
      brushedSufficient = isSufficient();
    }

    function isSufficient() { // make sure user can't zoom by clicking
      return brushExtent[1][0] - brushExtent[0][0] > 1 && brushExtent[1][1] - brushExtent[0][1] > 1;
    }

    function isInBrushExtent(d) {
      return brushExtent &&
        projection([d.Longitude, d.Latitude])[0] >= brushExtent[0][0] &&
        projection([d.Longitude, d.Latitude])[0] <= brushExtent[1][0] &&
        projection([d.Longitude, d.Latitude])[1] >= brushExtent[0][1] &&
        projection([d.Longitude, d.Latitude])[1] <= brushExtent[1][1];
    }


    //the brush still detects the zoom level as the original, not the zoomed in level
    // the current extent doesn't seem to be stored


    //brushEnd function
    function brushEnd() {

      brushing = false;

      //get the four corner coordinates
      const x0 = brushExtent[0][0];
      const x1 = brushExtent[1][0];
      const y0 = brushExtent[0][1];
      const y1 = brushExtent[1][1];


      if (brushedSufficient) {

        const x = -(x0 + x1) / 2;
        const y = -(y0 + y1) / 2;
        let k = 0.9 / Math.max((x1 - x0) / width, (y1 - y0) / height);
        if (k > 130) { k = 130 };
        transformedLevel = k;

        svg.transition().duration(750).call(
          zoom.transform,
          d3.zoomTransform(30, 30, 1)
            .translate(width / 2, height / 2)
            .scale(k)
            .translate(x, y),
        )

      }

    }

    function zoomed(e) {
      tooltip.hideTooltip();
      clicked = false;

      d3.selectAll(".selection").style("display", "none");
      d3.selectAll(".handle").style("display", "none");
      // svg.selectAll(".selection").attr("fill", texture.url()).attr("opacity", 1).attr("fill-opacity", 1)

      if (e.transform.k > 10) { //load more detailed geojson when more zoomed in
        d3.selectAll(".land2").style("display", "block");
        d3.selectAll(".land").style("display", "none");
      } else {
        d3.selectAll(".land2").style("display", "none");
        d3.selectAll(".land").style("display", "block");
      }


      // if (e.transform.k > 1) { //prevent the brush from showing up when resetZoom is clicked at initial scale

      //   d3.select(".selection").style("display", "block")
      //   d3.selectAll(".handle").style("display", "block");

      // }

      isZoomed = true;

      const transform = e.transform; //k,x,y
      transformed = transform;

      svg.selectAll('path')
        .attr('transform', transform)
        .attr("stroke-width", 1 / transform.k)

      svg.selectAll("circle")
        .attr('transform', transform)
        .attr('r', 5.5 / transform.k)
        .attr("stroke-width", isZoomed ? 1 / transformed.k : 1)
        .attr("fill", d => colorScale(d.Category))
        .style("opacity", d => function () {
          if (ids.includes(d.Id)) {
            if (activeCategories.includes(d.Category)) {
              return 1
            } else {
              return 0
            }
          } else {
            return 0
          }
          // activeCategories.includes(d.Category) ? 1 : 0).style("display", d => activeCategories.includes(d.Category) ? "inherit" : "none"
        })

      svg.select('.brush')
        .attr('transform', transform)
        .attr("stroke-width", isZoomed ? 1 / transformed.k : 1);

    }

    function resetZoom() {
      tooltip.hideTooltip();
      clicked = false;
      transformedLevel = 1;
      isZoomed = false;
      svg.transition()
        .duration(750)
        .call(zoom.transform, d3.zoomIdentity)
    }

    const worldmap = d3.json("./data/land3.geojson");
    const worldmapDetailed = d3.json("./data/land7.geojson"); //0.055 simplify is the max
    const points = d3.csv("./data/mapData3.csv");

    //IPSA & Earth4All are drawn twice, why??


    Promise.all([worldmap, points, worldmapDetailed]).then(function (values) {

      // const projection2 = d3.geoGilbert()
      //   .fitSize([200, 200], values[0])

      // const path2 = d3.geoPath(projection2);



      // projection = d3
      //   .geoIdentity()
      //   .fitSize([width, height], values[2]);
      // path = d3.geoPath().projection(projection);

      let data = values[1].filter(d => d.Latitude !== "-" && d.Latitude !== "");

      let organization = data.map(function (obj) {
        return obj.Organization;
      });
      organization = organization.filter(function (v, i) {
        return organization.indexOf(v) == i;
      });

      let location = data.map(function (obj) {
        return obj.Location;
      });
      location = location.filter(function (v, i) {
        return location.indexOf(v) == i;
      });

      const $terms = [...organization, ...location].sort();
      let $return = [];


      let focus = data.map(function (obj) {
        return obj.Focus;
      });
      focus = focus.filter(function (v, i) {
        return focus.indexOf(v) == i;
      });

      let categories = data.map(function (obj) {
        return obj.Category;
      });
      categories = categories.filter(function (v, i) {
        return categories.indexOf(v) == i;
      });

      let type = data.map(function (obj) {
        return obj.Type;
      });
      type = type.filter(function (v, i) {
        return type.indexOf(v) == i;
      });

      colorScale.domain(categories);


      //this part is to remove the weird artifacts (horizontal lines above and below the map)
      // draw first map just to get the bbox of the land
      svg.selectAll("path.land")
        .data(values[0].features)
        .join("path")
        .attr("class", "land")
        .attr("id", "land")
        .attr("d", path);

      // svg2.selectAll("path.main")
      //   .data(values[0].features)
      //   .join("path")
      //   .attr("class", "main")
      //   .attr("d", path2)


      const bbox = d3.select("#land").node().getBBox();

      // add a clipping path the show the central part of the map (move 3 down from top and 3 up from bottom)
      svg.append("defs")
        .append("clipPath")
        .attr("id", "clip")
        .append("rect")
        .attr("x", bbox.x)
        .attr("y", bbox.y + 3)
        .attr("width", bbox.width)
        .attr("height", bbox.height - 6);

      // now remove the land we drew
      svg.selectAll("path.land").remove();

      // and redraw it using the clipping mask
      svg.selectAll("path.land")
        .data(values[0].features)
        .join("path")
        .attr("class", "land")
        .attr("d", path)
        .attr("clip-path", "url(#clip)");

      svg.selectAll("path.land2")
        .data(values[2].features)
        .join("path")
        .attr("class", "land2")
        .attr("d", path)
        .attr("clip-path", "url(#clip)")
        .attr("display", "none")

      //need to come before points

      svg.append("g")
        .attr("class", "brush")
        .call(brush);

      // draw points
      svg.selectAll("circle.point")
        .data(data)
        .join("circle")
        .attr("class", "point")
        .attr("id", d => "id" + d.Id)
        .attr("cx", d => projection([+d.Longitude, +d.Latitude])[0])
        .attr("cy", d => projection([+d.Longitude, +d.Latitude])[1])
        .attr("stroke-width", 1)
        .attr("stroke", "#808080")
        .attr("r", 5.5)
        .attr("fill", d => colorScale(d.Category))
        .style("opacity", d => activeCategories.includes(d.Category) ? 1 : 0).style("display", d => activeCategories.includes(d.Category) ? "inherit" : "none")
        .on("mouseover", function (e, d) {
          if (!brushing) {
            d3.selectAll(".point").style("stroke", "#808080")
            d3.select(this).style("stroke", "black")
            showDetail(e, d);
          }
        })
        .on("mouseout", function (e, d) {
          if (clicked == false) {
            d3.selectAll(".point").style("stroke", "#808080")
          }
          hideDetail(d)
        })
        .on("click", function (e, d) {
          d3.selectAll(".point").style("stroke", "#808080")
          d3.select(this).style("stroke", "black")
          clicked = true;
        })


      $("#resetZoom").click(resetZoom);

      function strInArray(str, strArray) {
        for (var j = 0; j < strArray.length; j++) {
          if ((strArray[j].toLowerCase()).match(str.toLowerCase()) && $return.length < 5) {
            var $h = strArray[j].replace(str, "<strong>" + str + "</strong>");
            $return.push(
              '<li class="prediction-item"><span class="prediction-text">' +
              $h +
              "</span></li>"
            );
          }
        }
      }

      function nextItem(kp) {
        if ($(".focus").length > 0) {
          var $next = $(".focus").next(),
            $prev = $(".focus").prev();
        }

        if (kp == 38) {
          // Up

          if ($(".focus").is(":first-child")) {
            $prev = $(".prediction-item:last-child");
          }

          $(".prediction-item").removeClass("focus");
          $prev.addClass("focus");
        } else if (kp == 40) {
          // Down

          if ($(".focus").is(":last-child")) {
            $next = $(".prediction-item:first-child");
          }

          $(".prediction-item").removeClass("focus");
          $next.addClass("focus");
        }
      }

      $(function () {

        $("#search-bar").keydown(function (e) {
          $key = e.keyCode;
          if ($key == 38 || $key == 40) {
            nextItem($key);
            return;
          }

          setTimeout(function () {
            var $search = $("#search-bar").val();
            $return = [];

            strInArray($search, $terms);

            if ($search == "" || !$("input").val) {
              $(".output").html("").slideUp();
            } else {
              $(".output").html($return).slideDown();
            }

            $(".prediction-item").on("click", function () {

              $text = $(this).find("span").text();
              resetFilters();
              filterPoints(values[1], $text)

              $(".output").slideUp(function () {
                $(this).html("");
              });
              $("#search-bar").val($text);
            });

            $(".prediction-item:first-child").addClass("focus");
          }, 50);
        });
      });

      $("#search-bar").focus(function () {
        if ($(".prediction-item").length > 0) {
          $(".output").slideDown();
        }

        $("#searchform").submit(function (e) {
          e.preventDefault();
          $text = $(".focus").find("span").text();
          $(".output").slideUp();
          $("#search-bar").val($text);
          $("input").blur();
        });
      });

      $("#search-bar").blur(function () {
        if ($(".prediction-item").length > 0) {
          $(".output").slideUp();
        }
      });

      $("#reset").on("click", function () {
        resetZoom();
        resetPoints(data);
        $("#search-bar").val("");

      })


    });



    function createFilterStatus(filterName, layerOnName, statusString) {
      document.getElementById(filterName).addEventListener('change', function (e) {
        //remove popup
        clicked = false;
        d3.selectAll(".point").style("stroke", "#808080");
        tooltip.hideTooltip();

        if (e.target.value === layerOnName) {
          if (activeCategories.indexOf(statusString) == -1) {
            activeCategories.push(statusString)
          }

          // redraw using d3 here

          d3.selectAll("circle.point")
            .transition().duration(300)
            .style("opacity", d => activeCategories.includes(d.Category) ? 1 : 0).style("display", d => activeCategories.includes(d.Category) ? "inherit" : "none")


        } else {
          if (activeCategories.indexOf(statusString) !== -1) {
            var index = activeCategories.indexOf(statusString);
            activeCategories.splice(index, 1);
          }

          // redraw using d3 here
          d3.selectAll("circle.point")
            .transition().duration(300)
            .style("opacity", d => activeCategories.includes(d.Category) ? 1 : 0)
            .style("display", d => activeCategories.includes(d.Category) ? "inherit" : "none")
        }
      });

    }

    createFilterStatus('filter1', 'layer1On', 'Solutions & Politics')
    createFilterStatus('filter2', 'layer2On', 'Habitability & Hospitability')
    createFilterStatus('filter3', 'layer3On', 'Justice & Ethics')
    createFilterStatus('filter4', 'layer4On', 'Earth System Science')
    createFilterStatus('filter5', 'layer5On', 'Solutions & Economics')
    createFilterStatus('filter6', 'layer6On', 'Indigenous Knowledge')





    function filterPoints(data, term) {

      tooltip.hideTooltip();
      clicked = false;
      const filteredData = data.filter(d => d.Organization === term || d.Location === term)

      ids = filteredData.map(a => a.Id);


      let lat = filteredData[0].Latitude;
      let lon = filteredData[0].Longitude;

      if (term === "Australia") {
        lat = -26.463777;
        lon = 134.347707;
      } // create a mapping function for the locations

      if (term === "USA") {
        lat = 41.094497;
        lon = -99.032502;
      }

      const x = projection([lon, lat])[0];
      const y = projection([lon, lat])[1];
      let k = 10;

      if (term === "Australia" || term === "USA") {
        k = 5;
      }

      svg.transition().duration(750).call(
        zoom.transform,
        d3.zoomTransform(30, 30, 1)
          .translate(width / 2, height / 2)
          .scale(k)
          .translate(-x, -y),
      )

      d3.selectAll("circle.point")
        .style("opacity", d => ids.includes(d.Id) ? 1 : 0)
        .style("display", d => ids.includes(d.Id) ? "inherit" : "none")

    }

    function resetPoints(data) {
      tooltip.hideTooltip();
      clicked = false;
      resetFilters();
      svg.selectAll("circle.point")
        .data(data)
        .join("circle")
        .attr("class", "point")
        .attr("cx", d => projection([d.Longitude, d.Latitude])[0])
        .attr("cy", d => projection([d.Longitude, d.Latitude])[1])
        .attr("r", 5.5)
        .attr("stroke-width", isZoomed ? 1 / transformedLevel : 1)
        .attr("stroke", "#808080")
        .attr("fill", d => colorScale(d.Category))
        .style("opacity", d => activeCategories.includes(d.Category) ? 1 : 0).style("display", d => activeCategories.includes(d.Category) ? "inherit" : "none")
        .on("mouseover", (e, d) => showDetail(e, d))
        .on("mouseout", d => hideDetail(d))

    }


    function resetFilters() {
      console.log("reset filters")
      activeCategories = ['Solutions & Politics', 'Habitability & Hospitability', 'Justice & Ethics', 'Earth System Science', 'Solutions & Economics', 'Indigenous Knowledge'];

      $("#layer1On").prop("checked", true);
      $("#layer1Off").prop("checked", false);
      $("#layer2On").prop("checked", true);
      $("#layer2Off").prop("checked", false);
      $("#layer3On").prop("checked", true);
      $("#layer3Off").prop("checked", false);
      $("#layer4On").prop("checked", true);
      $("#layer4Off").prop("checked", false);
      $("#layer5On").prop("checked", true);
      $("#layer5Off").prop("checked", false);
      $("#layer6On").prop("checked", true);
      $("#layer6Off").prop("checked", false);
    }


    function showDetail(e, d) {

      let fill = colorScale(d.Category)

      svg.select(`#id${d.Id}`).raise();
      let content = `<div id="map"></div><h4> ${d.Organization}  </h4>
      <p> ${d.Contact_address} </p>
      <p> ${d.Contact_phone.replaceAll(`"`, ``)} </p>
      <p>  <a href='${d.Contact_site}' target='_blank'>Website →</a></p>
      <span class="close">X</span>
      <span class="more">More→</span>`;


      tooltip.showTooltip(content, e);

      d3.selectAll(".more").on("click", function () {
        content = `<h4> ${d.Organization}  </h4>
        <span class="focusarea" style='background-color:${fill} '> ${d.Focus} </span>
        <p> ${d.Mission} </p>
      <span class="close">X</span>`;  // <span class="back">Back→</span>
        tooltip.showTooltip(content, e);

        d3.selectAll(".close").on("click", function () {
          tooltip.hideTooltip();
          clicked = false;
          d3.selectAll(".point").style("stroke", "#808080")
        })

      })

      // d3.selectAll(".back").on("click", function () {
      //   console.log("back")
      //   content = `<div id="map"></div><h4> ${d.Organization}  </h4>
      // <p> ${d.Contact_address} </p>
      // <p> ${d.Contact_phone.replaceAll(`"`, ``)} </p>
      // <p>  <a href='${d.Contact_site}' target='_blank'>Website →</a></p>
      // <span class="close">X</span>
      // <span class="more">More→</span>`;

      //   tooltip.showTooltip(content, e);

      //   d3.selectAll(".close").on("click", function () {
      //     tooltip.hideTooltip();
      //     clicked = false;
      //     d3.selectAll(".point").style("stroke", "#808080")
      //   })

      // })



      let map = new mapboxgl.Map({
        container: 'map', // container element id
        style: 'mapbox://styles/jhjanicki/clhit1ezw01ik01pgbs36b1gj',
        center: [d.Longitude, d.Latitude], // initial map center in [lon, lat]
        zoom: 15
      });

      var marker = new mapboxgl.Marker()
        .setLngLat([d.Longitude, d.Latitude])
        .addTo(map);

      d3.selectAll(".close").on("click", function () {
        tooltip.hideTooltip();
        clicked = false;
        d3.selectAll(".point").style("stroke", "#808080")
      })

    }

    function hideDetail(d) {
      if (!clicked) {
        tooltip.hideTooltip(); // remove if want tooltip to stay open
        clicked = false;
      }

    }



  </script>
</body>

</html>